 <!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mapa de Intensidade do Vento</title>

  <!-- Biblioteca Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <!-- Fonte do Google -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

  <!-- Plugin de mapa de calor -->
  <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>

  <style>
    :root{
      --bg: #f4f7fb;
      /* paleta verde */
      --primary-1: #1f8f3e; /* verde mais escuro */
      --primary-2: #66c26a; /* verde mais claro */
      --card: #ffffff;
      --muted: #666;
      --accent: #28a745; /* verde de destaque */
    }

    /* ===== Layout geral ===== */
    body {
      margin: 0;
      font-family: "Inter", "Segoe UI", Roboto, sans-serif;
      background-color: var(--bg);
      color: #222;
      display: flex;
      flex-direction: column;
      height: 100vh;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    header {
      background: linear-gradient(90deg, var(--primary-1), var(--primary-2));
      color: white;
      padding: 18px 24px;
      text-align: left;
      box-shadow: 0 4px 18px rgba(7,60,40,0.12);
      display: flex;
      align-items: center;
      gap: 16px;
    }

    /* logo pequena no cabeçalho */
    .logo {
      width: 48px;
      height: 48px;
      flex: 0 0 48px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(255,255,255,0.06);
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(2,6,23,0.06) inset;
    }
    .logo svg { width: 28px; height: 28px; display:block }

    header h1 {
      margin: 0;
      font-size: 1.4rem;
      letter-spacing: 0.4px;
      font-weight: 600;
    }

    header p {
      margin: 0;
      font-size: 0.95rem;
      opacity: 0.95;
      color: rgba(255,255,255,0.95);
      font-weight: 300;
    }

    main {
      flex: 1;
      display: flex;
      gap: 8px; /* reduzir espaço entre mapa e painel */
      align-items: flex-start;
      padding: 12px 12px; /* menos espaço lateral */
    }

    #map {
      width: 100%;
      height: 100%;
      border-radius: 10px;
      box-shadow: 0 10px 30px rgba(2,6,23,0.08);
      overflow: hidden;
      border: none; /* remover borda para ficar colado ao painel */
    }

    /* Sobreposição de carregamento */
    .loading {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(255,255,255,0.6);
      z-index: 9999;
      font-weight: 600;
      color: var(--muted);
      backdrop-filter: blur(3px);
    }

    .spinner {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      border: 4px solid rgba(0,0,0,0.08);
      border-top-color: var(--accent);
      animation: spin 1s linear infinite;
      margin-right: 12px;
    }

    @keyframes spin{to{transform:rotate(360deg)}}

    footer {
      background: #0f1720;
      color: #cbd5e1;
      text-align: center;
      padding: 12px 0;
      font-size: 0.85rem;
      letter-spacing: 0.3px;
    }

    /* ===== Legenda ===== */
    .legend {
      background: linear-gradient(180deg, rgba(255,255,255,0.98), rgba(250,250,250,0.92));
      padding: 12px 14px;
      line-height: 1.4em;
      border-radius: 10px;
  box-shadow: 0 6px 20px rgba(2,60,24,0.12);
      font-size: 13px;
      font-family: Inter, sans-serif;
      color: #0b2540;
      min-width: 160px;
    }

    .legend i {
      width: 16px;
      height: 16px;
      display: inline-block;
      margin-right: 8px;
      vertical-align: middle;
      border-radius: 4px;
      box-shadow: 0 1px 2px rgba(2,6,23,0.06) inset;
    }

    .map-control {
      background: rgba(255,255,255,0.95);
      padding: 8px 10px;
      border-radius: 8px;
      box-shadow: 0 6px 18px rgba(2,60,24,0.12);
      font-size: 13px;
    }

    .filter-panel {
        width: 260px;
        padding: 12px;
        position: static; /* colocado fora do mapa para não obstruí-lo */
        margin-left: 6px;
        border-radius: 10px;
        background: linear-gradient(180deg, rgba(255,255,255,0.98), rgba(250,250,250,0.9));
        box-shadow: 0 8px 30px rgba(2,60,24,0.06);
        font-family: Inter, sans-serif;
        color: #083a20; /* texto em verde escuro */
        flex-shrink: 0;
        position: relative;
      }

    /* Estilos do painel recolhível + transição suave de fade/deslizamento */
    .filter-panel { transition: width 260ms ease, box-shadow 200ms ease; }
    .filter-panel .filter-header{display:flex; align-items:center; justify-content:space-between; gap:8px}
    .filter-panel .filter-header h3{font-size:14px; margin:0;}
    .filter-panel .filter-header button{background:transparent;border:0;font-size:16px;padding:4px 6px;border-radius:6px;cursor:pointer}

    /* Animar os elementos filhos (área de conteúdo) em vez de display:none para obter fade suave */
    .filter-panel > *:not(.filter-header){
      transition: opacity 220ms ease, transform 260ms ease, max-height 260ms ease;
      transform-origin: left center;
    }

    .filter-panel.collapsed{width:44px;padding:8px;overflow:visible}
    .filter-panel.collapsed .filter-header h3{display:none}
    .filter-panel.collapsed > *:not(.filter-header){
      opacity: 0;
      transform: translateX(8px);
      max-height: 0;
      pointer-events: none;
    }

    /* Indicador visual quando recolhido: uma pequena barra vertical na borda esquerda */
    .filter-panel.collapsed::after{
      content: '';
      position: absolute;
      left: -8px;
      top: 50%;
      transform: translateY(-50%);
      width: 6px;
      height: 46px;
      background: linear-gradient(180deg, var(--primary-1), var(--primary-2));
      border-radius: 4px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.12);
    }

  .filter-panel h3{margin:0 0 8px 0; font-size:14px}
  .filter-panel label{font-size:12px; color:#234;}
  .filter-panel input[type=date]{width:100%; padding:6px; margin:6px 0}
  .filter-panel .actions{display:flex; gap:8px; justify-content:space-between}
  .filter-panel button{flex:1; padding:6px 8px; border-radius:6px; border:0; cursor:pointer}
  .filter-panel input[type=search]{width:100%; padding:6px; margin:6px 0 8px 0; box-sizing:border-box; border-radius:6px; border:1px solid #e6eef9}
  .station-item{display:flex; align-items:center; gap:8px; padding:6px 4px; border-radius:6px}
  .station-item:hover{background:rgba(2,60,24,0.02)}
  .station-item input{width:16px; height:16px}
  .btn-apply{background:var(--primary-1); color:white}
  .btn-clear{background:#f1f5f9; color:#083a20}

  /* ===== Estilo personalizado do checkbox (destaque verde) ===== */
  input[type="checkbox"] {
    accent-color: var(--primary-1); /* navegadores modernos: mudança direta de cor */
    cursor: pointer;
    width: 18px;
    height: 18px;
  }

  /* fallback para navegadores antigos: estiliza o checkbox de forma mais direta */
  input[type="checkbox"]:checked {
    background-color: var(--primary-1);
    border-color: var(--primary-1);
  }

  input[type="checkbox"]:focus {
    outline: 2px solid var(--primary-2);
    outline-offset: 2px;
  }

  /* ===== Status indicator (exibindo X de Y estações) ===== */
  #statusIndicator {
    background: linear-gradient(135deg, rgba(31, 143, 62, 0.95) 0%, rgba(102, 194, 106, 0.9) 100%);
    color: white;
    padding: 8px 14px;
    border-radius: 8px;
    font-size: 12px;
    font-weight: 600;
    box-shadow: 0 2px 8px rgba(31, 143, 62, 0.25);
    display: flex;
    align-items: center;
    gap: 6px;
    white-space: nowrap;
    transition: all 300ms ease;
  }

  #statusIndicator::before {
    content: '●';
    display: inline-block;
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.9);
    animation: pulse 2s infinite;
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.6; }
  }

  /* ===== Estilos de animação das partículas (partículas de vento) ===== */
  @keyframes windParticle {
    0% {
      opacity: 1;
      transform: translate(0, 0) scale(1);
    }
    50% {
      opacity: 0.8;
    }
    100% {
      opacity: 0;
      transform: translate(var(--px), var(--py)) scale(0.3);
    }
  }

  @keyframes particleGlow {
    0% {
      box-shadow: 0 0 8px rgba(31, 143, 62, 0.8), 0 0 16px rgba(102, 194, 106, 0.4);
    }
    50% {
      box-shadow: 0 0 12px rgba(31, 143, 62, 0.6), 0 0 20px rgba(102, 194, 106, 0.3);
    }
    100% {
      box-shadow: 0 0 2px rgba(31, 143, 62, 0), 0 0 4px rgba(102, 194, 106, 0);
    }
  }

  .wind-particle {
    position: absolute;
    pointer-events: none;
    width: 4px;
    height: 4px;
    border-radius: 50%;
    background: radial-gradient(circle, rgba(102, 194, 106, 1) 0%, rgba(31, 143, 62, 0.8) 100%);
    animation: windParticle var(--duration) ease-out forwards, particleGlow var(--duration) ease-out forwards;
    box-shadow: 0 0 8px rgba(31, 143, 62, 0.8), 0 0 16px rgba(102, 194, 106, 0.4);
  }

  /* ===== Estilo aprimorado do popup ===== */
  .leaflet-popup-content-wrapper {
    background: transparent !important;
    box-shadow: 0 3px 12px rgba(31, 143, 62, 0.2) !important;
    border-radius: 10px !important;
    border: none !important;
    padding: 0 !important;
  }

  .leaflet-popup-content {
    margin: 0 !important;
    width: auto !important;
  }

  .leaflet-popup-tip {
    background: rgba(255, 255, 255, 0.98) !important;
    box-shadow: 0 1px 3px rgba(31, 143, 62, 0.1) !important;
  }

  .leaflet-popup-close-button {
    color: #1f8f3e !important;
    font-weight: 700 !important;
    font-size: 20px !important;
    opacity: 0.6 !important;
    right: 8px !important;
    top: 8px !important;
  }

  .leaflet-popup-close-button:hover {
    opacity: 1 !important;
  }

  /* ===== Garante que o painel de popup fique acima das partículas ===== */
  /* Eleva o painel de popup logo acima de particlesLayer (650) */
  .leaflet-pane.leaflet-popup-pane { z-index: 700 !important; }
  .leaflet-pane.leaflet-shadow-pane { z-index: 660 !important; }

  /* ==== Correção das linhas brancas entre tiles ==== */
  .leaflet-container {
  background: #e6e9ef; /* fundo neutro para mascarar pequenos gaps */
  }

  .leaflet-tile {
  border: none !important;
  box-shadow: none !important;
  transform: translate3d(0, 0, 0);
  image-rendering: optimizeSpeed;
  background-color: transparent;
  /* Ajuste mínimo de margem apenas em monitores Retina */
  }

  @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
  .leaflet-tile {
    margin: -0.25px !important; /* pequeno ajuste apenas em telas de alta densidade */
  }
  }

    .leaflet-tile-container {
    will-change: transform;
    }

  .leaflet-layer {
  transform: translateZ(0);
  }

  </style>
</head>

<body>
  <header>
    <div class="logo" id="logoContainer" title="Mapa do Vento" aria-hidden="false">
       <!-- o logo será carregado aqui automaticamente de assets/logo.svg ou assets/logo.png
         Se nenhum arquivo externo for encontrado, será usado um fallback SVG inline pequeno. -->
    </div>
    <div>
      <h1>Mapa Interativo de Visualização dos Ventos</h1>
      <p>Visualização dos últimos dados sobre a intensidade e direção do vento captados pelas das Estações Climáticas</p>
    </div>
  </header>

  <main>
    <div id="map-wrapper" style="flex:1; height:80vh; position:relative;">
      <div id="map"></div>
      <div id="statusIndicator" style="position:absolute; bottom:20px; left:20px; z-index:500;">
        Exibindo 0 de 0 estações
      </div>
      <div id="loading" class="loading">
        <div class="spinner" aria-hidden="true"></div>
        <div>Carregando dados…</div>
      </div>
    </div>

    <!-- Painel de filtros movido para a direita para não obstruir a visualização -->
    <div class="filter-panel map-control" id="filterPanel">
      <div class="filter-header">
        <h3>Filtrar dados</h3>
        <button id="toggleCollapse" aria-label="Recolher painel">◀</button>
      </div>
        <div style="display:flex; align-items:center; justify-content:space-between; gap:8px; margin:8px 0;">
          <div id="selectedCount" style="font-size:12px; color:#234; font-weight:600;">Selecionadas: 0</div>
          <label style="font-size:12px; display:flex; gap:8px; align-items:center; cursor:pointer;">
            <input id="autoApply" type="checkbox"> Aplicar automaticamente
          </label>
        </div>
      <label for="stationSearch">Estação (múltipla):</label>
      <input id="stationSearch" type="search" placeholder="Pesquisar estação...">
      <div style="display:flex; gap:8px; align-items:center; margin-bottom:6px;">
        <label style="font-size:12px; margin:0; display:flex; gap:6px; align-items:center; cursor:pointer;"><input id="selectAllStations" type="checkbox"> Selecionar estação</label>
      </div>
      <div id="stationList" style="max-height:240px; overflow:auto; border-radius:8px; padding:6px; border:1px solid rgba(10,20,40,0.04); background:linear-gradient(180deg,#fff,#fbfdff)"></div>
      <label for="dateFrom">Data (de):</label>
      <input id="dateFrom" type="date" disabled />
      <label for="dateTo">Data (até):</label>
      <input id="dateTo" type="date" disabled />
      <div class="actions">
        <button id="applyFilter" class="btn-apply">Aplicar</button>
        <button id="clearFilter" class="btn-clear">Limpar</button>
      </div>
    </div>
  </main>

  <footer>
    Desenvolvido por Vitor Klafke — Protótipo V3.0
  </footer>

  <script>
    // ===== Inicializa o mapa =====
    // Tenta carregar um logo externo da pasta assets (assets/logo.svg ou assets/logo.png)
    // Se não existir, injeta um pequeno SVG inline como fallback.
    (function loadLogo(){
      const container = document.getElementById('logoContainer');
      if (!container) return;
      const paths = ['assets/logo.svg','assets/logo.png','logo.png'];
      let tried = 0;
      function tryNext(){
        if (tried >= paths.length) {
          // injeta SVG inline de fallback
          container.innerHTML = `
            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" role="img" aria-hidden="true">
              <path d="M3 12c0-2.761 2.239-5 5-5h7.5a1 1 0 1 0 0-2H8c-3.866 0-7 3.134-7 7s3.134 7 7 7h11" fill="none" stroke="#fff" stroke-opacity="0.92" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M7 10.5a2.5 2.5 0 1 0 0 5" fill="none" stroke="#fff" stroke-opacity="0.92" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>`;
          return;
        }
        const p = paths[tried++];
        const img = new Image();
        img.onload = function(){
          img.alt = 'Logo';
          img.style.width = '28px';
          img.style.height = '28px';
          img.style.display = 'block';
          container.innerHTML = '';
          container.appendChild(img);
        };
        img.onerror = function(){ tryNext(); };
        img.src = p + '?v=' + Date.now(); // evita cache durante o desenvolvimento
      }
      tryNext();
    })();

    // Retorna o mesmo logo usado no cabeçalho em HTML (src da imagem se disponível, senão SVG alternativo)
    function getHeaderLogoHTML(size = 28){
      const container = document.getElementById('logoContainer');
      const img = container ? container.querySelector('img') : null;
      if (img && img.src) {
        // Usa exatamente a mesma origem de imagem carregada no cabeçalho
        return `<img src="${img.src}" alt="Logo" width="${size}" height="${size}" style="display:block;"/>`;
      }
      // Alternativa para um SVG inline semelhante à alternativa do cabeçalho
      return `
        <svg width="${size}" height="${size}" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" role="img" aria-hidden="true">
          <path d="M3 12c0-2.761 2.239-5 5-5h7.5a1 1 0 1 0 0-2H8c-3.866 0-7 3.134-7 7s3.134 7 7 7h11" fill="none" stroke="#1f8f3e" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M7 10.5a2.5 2.5 0 1 0 0 5" fill="none" stroke="#1f8f3e" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>`;
    }

    const map = L.map("map").setView([-29.72, -52.45], 9);

    // Camada de tiles: usa a configuração mais simples (igual ao indexV5) — ajuda a evitar emendas em alguns navegadores
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 18,
      attribution: "&copy; OpenStreetMap contributors",
    }).addTo(map);

    // Controle de escala
    L.control.scale({ metric: true, imperial: false }).addTo(map);

    // ===== Função para converter direção (°) em texto =====
    function direcaoTexto(graus) {
      const dirs = ["N", "NE", "L", "SE", "S", "SO", "O", "NO"];
      const idx = Math.round(graus / 45) % 8;
      return dirs[idx];
    }

    // ===== Unificação de categorias de intensidade =====
    // Fonte única de verdade para faixas, nomes e cores.
    // Ordem crescente por velocidade.
    const WIND_CATEGORIES = [
      { name: 'Muito Fraco',  min: -Infinity, max: 1,       color: '#005cff' },
      { name: 'Fraco',        min: 1,         max: 2,       color: '#00cccc' },
      { name: 'Moderado',     min: 2,         max: 3.5,     color: '#66cc00' },
      { name: 'Forte',        min: 3.5,       max: 4,       color: '#ffcc00' },
      { name: 'Muito Forte',  min: 4,         max: 6,       color: '#ff3b00' },
      { name: 'Extremo',      min: 6,         max: Infinity,color: '#b30000' }
    ];

    function findWindCategory(v){
      return WIND_CATEGORIES.find(c => v >= c.min && v < c.max) || WIND_CATEGORIES[0];
    }

    // Helpers de cor e raio usando categorias unificadas
    function getColor(v) {
      return findWindCategory(v).color;
    }

    function getRadius(v){
      return Math.max(4, Math.min(14, 4 + v * 2));
    }

    // ===== Sistema de partículas =====
    let particlesEnabled = true;
    let particleIntervals = []; // rastreia intervalos para limpeza
    
    // Cria a camada de partículas - posicionada absolutamente sobre o mapa
  const particlesLayer = document.createElement('div');
  particlesLayer.id = 'particlesLayer';
  // coloca abaixo do popup (700) e das dicas, mas acima dos blocos de mapa
  particlesLayer.style.cssText = 'position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:650;';
    
    // Adiciona após o mapa estar pronto
    setTimeout(() => {
      const mapDiv = document.getElementById('map');
      if (mapDiv) {
        // adiciona dentro de #map para que os painéis do Leaflet (popup) possam ficar por cima
        mapDiv.appendChild(particlesLayer);
      }
    }, 100);

    function createWindParticle(lat, lon, dirGraus, velocity) {
      if (!particlesEnabled) return;
      
      try {
        // Garante que particlesLayer exista
        if (!particlesLayer || !particlesLayer.parentNode) {
          console.warn('Particles layer not ready');
          return;
        }
        
        const mapPoint = map.latLngToContainerPoint([lat, lon]);
        if (!mapPoint || mapPoint.x === undefined || mapPoint.y === undefined) return;
        
        const particle = document.createElement('div');
        particle.className = 'wind-particle';
        
        // Converte direção para radianos e calcula deslocamento da partícula
        const radians = (dirGraus * Math.PI) / 180;
        const distance = Math.max(30, Math.min(120, velocity * 15)); // distância baseada na velocidade
        const duration = Math.max(0.8, Math.min(2, 2 - velocity * 0.2)); // partículas mais rápidas para vento mais forte
        
        const px = Math.cos(radians) * distance;
        const py = Math.sin(radians) * distance;
        
        particle.style.left = mapPoint.x + 'px';
        particle.style.top = mapPoint.y + 'px';
        particle.style.setProperty('--px', px + 'px');
        particle.style.setProperty('--py', py + 'px');
        particle.style.setProperty('--duration', duration + 's');
        
        particlesLayer.appendChild(particle);
        
        // Remove a partícula após o fim da animação
        setTimeout(() => {
          if (particle && particle.parentNode) {
            particle.remove();
          }
        }, duration * 1000);
      } catch (e) {
        console.error('Particle creation error:', e);
      }
    }

    function startParticleLoopForLocation(lat, lon, dirGraus, velocity) {
      if (!particlesEnabled) return;
      
      // Cria partículas continuamente
      const interval = setInterval(() => {
        if (!particlesEnabled) {
          clearInterval(interval);
          return;
        }
        // As partículas seguem a EXATA direção do vento (sem aleatoriedade)
        createWindParticle(lat, lon, dirGraus, velocity);
      }, 500); // cria uma nova partícula a cada 500ms
      
      particleIntervals.push(interval);
    }

    function stopAllParticleLoops() {
      particleIntervals.forEach(interval => clearInterval(interval));
      particleIntervals = [];
      document.querySelectorAll('.wind-particle').forEach(p => p.remove());
    }

    // Inicia loops para todo o conjunto de dados sem reconstruir camadas/marcadores
    function startParticlesForData(dados){
      if (!particlesEnabled) return;
      stopAllParticleLoops();
      dados.forEach(d => {
        startParticleLoopForLocation(d.lat, d.lon, d.dir_media, d.vel_media);
      });
    }

    // Contêineres de camada
    let heatLayer;
    const markersLayer = L.layerGroup().addTo(map);

    // Controle de alternância do heatmap
    const heatToggle = L.control({ position: 'topright' });
    heatToggle.onAdd = function () {
      const div = L.DomUtil.create('div', 'map-control');
      div.innerHTML = `
        <label style="user-select:none; display:block; margin-bottom:8px;">
          <input type="checkbox" id="toggleHeat" checked> Mostrar heatmap
        </label>
        <label style="user-select:none">
          <input type="checkbox" id="toggleParticles" checked> Partículas do vento
        </label>`;
      L.DomEvent.disableClickPropagation(div);
      return div;
    };
    heatToggle.addTo(map);

    // Pausa partículas quando um popup está aberto; retoma ao fechar
    map.on('popupopen', () => {
      particlesEnabled = false;
      stopAllParticleLoops();
    });
    map.on('popupclose', () => {
      particlesEnabled = true;
      if (currentData && currentData.length) {
        startParticlesForData(currentData);
      }
    });

    document.addEventListener('change', e => {
      if (e.target && e.target.id === 'toggleHeat') {
        if (e.target.checked) {
          if (heatLayer) map.addLayer(heatLayer);
        } else {
          if (heatLayer) map.removeLayer(heatLayer);
        }
      }
      if (e.target && e.target.id === 'toggleParticles') {
        particlesEnabled = e.target.checked;
        if (!e.target.checked) {
          // remove todas as partículas ativas e interrompe os loops
          stopAllParticleLoops();
        } else {
          // reinicia partículas para o conjunto filtrado atual quando reativado
          if (currentData && currentData.length) {
            startParticlesForData(currentData);
          }
        }
      }
    });

    // ===== Carrega o JSON =====
  let originalData = [];
  let currentData = [];

    function renderData(dados){
      currentData = dados.slice();
      const heatData = dados.map(d => [d.lat, d.lon, (d.vel_media || 0) / 4]);

      if (heatLayer) map.removeLayer(heatLayer);

      stopAllParticleLoops();

      heatLayer = L.heatLayer(heatData, {
        radius: 55,
        blur: 20,
        maxZoom: 12,
        minOpacity: 0.25,
        gradient: {
          0.0: '#0000ff',
          0.25: '#00ffff',
          0.5: '#00ff00',
          0.75: '#ffff00',
          1.0: '#ff0000'
        }
      }).addTo(map);

      markersLayer.clearLayers();
      dados.forEach(d => {
        const cat = findWindCategory(d.vel_media || 0);
        const color = cat.color;
        const radius = getRadius(d.vel_media);

        const arrowHtml = `<div style="position:absolute;width:100%;height:100%;display:flex;align-items:center;justify-content:center;pointer-events:none;transform:rotate(${d.dir_media}deg);">
          <svg width="16" height="16" viewBox="0 0 24 24" style="filter: drop-shadow(0 1px 1px rgba(0,0,0,0.3));">
            <path d="M12 2 L19 21 L12 17 L5 21 Z" fill="white" stroke="#1b2b3a" stroke-width="0.5"/>
          </svg>
        </div>`;

        const marker = L.circleMarker([d.lat, d.lon], {
          radius: radius,
          color: '#1b2b3a',
          weight: 1,
          fillColor: color,
          fillOpacity: 0.95
        }).addTo(markersLayer);

        const markerElement = marker.getElement();
        if (markerElement) {
          markerElement.innerHTML += arrowHtml;
        }

  // Use a logo para criar um popup mais informativo e visualmente atraente, mantendo a consistência com o design do site.
  const logoHtml = `<img src="assets/logo.png" alt="Logo" width="28" height="28" style="display:block;" />`;

        const arrowSvg = `<svg width="28" height="28" viewBox="0 0 24 24" style="transform-origin:center; transform:rotate(${d.dir_media}deg); display:inline-block; vertical-align:middle; margin-right:8px; flex-shrink:0;"><path d="M12 2 L19 21 L12 17 L5 21 Z" fill="#1f8f3e" stroke="#1b2b3a" stroke-width="0.5"/></svg>`;

        const popupContent = `
          <div style="
            font-family: Inter, sans-serif;
            color: #083a20;
            background: linear-gradient(135deg, rgba(255,255,255,0.98) 0%, rgba(250,254,252,0.96) 100%);
            border-left: 4px solid #1f8f3e;
            border-radius: 8px;
            padding: 14px 14px;
            min-width: 240px;
            box-shadow: 0 2px 8px rgba(31,143,62,0.15);
          ">
            <div style="display:flex; align-items:center; gap:8px; margin-bottom:12px;">
              ${logoHtml}
              <div>
                <div style="font-size:14px; font-weight:700; color:#1f8f3e;">${d.estacao}</div>
                <div style="font-size:11px; color:#66c26a; font-weight:500;">Estação Meteorológica</div>
              </div>
            </div>
            
            <div style="background:rgba(31,143,62,0.06); border-radius:6px; padding:10px; margin-bottom:10px;">
              <div style="display:flex; align-items:center; gap:8px; margin-bottom:8px;">
                ${arrowSvg}
                <div>
                  <div style="font-size:12px; color:#666;">Velocidade do Vento</div>
                  <div style="font-size:18px; font-weight:700; color:#1f8f3e;">${(d.vel_media||0).toFixed(2)} <span style="font-size:12px;">m/s</span></div>
                </div>
              </div>
            </div>
            
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
              <div style="background:#f0f8f4; border-radius:6px; padding:8px; text-align:center;">
                <div style="font-size:11px; color:#666; margin-bottom:4px;">Direção</div>
                <div style="font-size:14px; font-weight:700; color:#1f8f3e;">${direcaoTexto(d.dir_media)}</div>
                <div style="font-size:10px; color:#999;">${d.dir_media}°</div>
              </div>
              <div style="background:#f0f8f4; border-radius:6px; padding:8px; text-align:center;">
                <div style="font-size:11px; color:#666; margin-bottom:4px;">Intensidade</div>
                <div style="font-size:14px; font-weight:700; color:${color};">●</div>
                <div style="font-size:10px; color:#999;">${cat.name}</div>
              </div>
            </div>
          </div>
        `;

        marker.bindPopup(popupContent);
      });

      // Inicia loops de partículas para todos os pontos (mantido separado para pausar/retomar)
      startParticlesForData(dados);

      // oculta sobreposição de carregamento
      const loading = document.getElementById('loading');
      if (loading) loading.style.display = 'none';

      // Atualiza o indicador de status
      const statusIndicator = document.getElementById('statusIndicator');
      if (statusIndicator) {
        statusIndicator.textContent = `Exibindo ${dados.length} de ${originalData.length} estações`;
      }
    }

    fetch('vento/vento.json')
      .then(res => res.json())
      .then(dados => {
        originalData = dados || [];

        // preenche a lista de estações (checkboxes + busca)
        const stationList = document.getElementById('stationList');
        const stationSearch = document.getElementById('stationSearch');
        const selectAllStations = document.getElementById('selectAllStations');
        const stations = Array.from(new Set(originalData.map(d => d.estacao))).sort((a,b)=>a.localeCompare(b));
        stations.forEach((s, idx) => {
          const item = document.createElement('div'); item.className = 'station-item';
          const input = document.createElement('input'); input.type = 'checkbox'; input.value = s; input.id = `st-${idx}`;
          const label = document.createElement('label'); label.htmlFor = `st-${idx}`; label.style.margin = '0'; label.textContent = s;
          item.appendChild(input); item.appendChild(label);
          stationList.appendChild(item);
        });

            function debounce(fn, wait){
              let t = null;
              return function(...args){
                clearTimeout(t);
                t = setTimeout(()=> fn.apply(this,args), wait);
              };
            }

            const autoApplyEl = document.getElementById('autoApply');
            const selectedCountEl = document.getElementById('selectedCount');

            function updateStationListFilter(){
              const q = stationSearch.value.trim().toLowerCase();
              Array.from(stationList.children).forEach(child => {
                const txt = child.textContent.toLowerCase();
                child.style.display = txt.includes(q) ? '' : 'none';
              });
            }

            const onSearchInput = debounce(()=>{
              updateStationListFilter();
              if (autoApplyEl && autoApplyEl.checked) applyFilters(null);
            }, 220);

            stationSearch.addEventListener('input', onSearchInput);

            function updateSelectedCount(){
              const selected = Array.from(document.querySelectorAll('#stationList input[type=checkbox]:checked')).length;
              if (selectedCountEl) selectedCountEl.textContent = `Selecionadas: ${selected}`;
            }

            stationList.addEventListener('change', e=>{
              if (e.target && e.target.matches('input[type=checkbox]')){
                updateSelectedCount();
                if (autoApplyEl && autoApplyEl.checked) applyFilters(null);
              }
            });

            // inicializa a contagem de selecionadas
            updateSelectedCount();

        // seleciona todas as visíveis
        selectAllStations.addEventListener('change', () => {
          const visible = Array.from(stationList.querySelectorAll('.station-item')).filter(el => el.style.display !== 'none');
          visible.forEach(el => {
            const cb = el.querySelector('input[type=checkbox]'); if (cb) cb.checked = selectAllStations.checked;
          });
        });

        const hasTimestamp = originalData.some(d => d.timestamp || d.data || d.date);
        const dateFrom = document.getElementById('dateFrom');
        const dateTo = document.getElementById('dateTo');
        if (hasTimestamp){
          dateFrom.disabled = false; dateTo.disabled = false;
        } else {
          dateFrom.disabled = true; dateTo.disabled = true;
          dateFrom.title = 'Sem histórico de data nos dados';
          dateTo.title = 'Sem histórico de data nos dados';
        }

        // inicial
        renderData(originalData);

        function applyFilters(intensityIndex = null){
          const selected = Array.from(document.querySelectorAll('#stationList input[type=checkbox]:checked')).map(o=>o.value);
          let filtered = originalData.slice();
          if (selected.length>0) filtered = filtered.filter(d=> selected.includes(d.estacao));

          if (hasTimestamp){
            const fromVal = dateFrom.value; const toVal = dateTo.value;
            if (fromVal) filtered = filtered.filter(d=> new Date((d.timestamp||d.data||d.date)) >= new Date(fromVal));
            if (toVal) filtered = filtered.filter(d=> new Date((d.timestamp||d.data||d.date)) <= new Date(toVal));
          }

          // intensityIndex: mapa as categorias da legenda para filtrar por intensidade (null = sem filtro, mostrar todas)
          if (typeof intensityIndex === 'number'){
            const r = WIND_CATEGORIES[intensityIndex] || null;
            if (r) filtered = filtered.filter(d=> {
              const v = (d.vel_media||0);
              return v >= r.min && v < r.max;
            });
          }

          renderData(filtered);
        }

        document.getElementById('applyFilter').addEventListener('click', ()=> applyFilters(null));

        document.getElementById('clearFilter').addEventListener('click', ()=>{
          Array.from(document.querySelectorAll('#stationList input[type=checkbox]')).forEach(cb=>cb.checked = false);
          const stationSearchEl = document.getElementById('stationSearch'); if (stationSearchEl) stationSearchEl.value = '';
          const selectAllEl = document.getElementById('selectAllStations'); if (selectAllEl) selectAllEl.checked = false;
          dateFrom.value = '';
          dateTo.value = '';
          const active = document.querySelectorAll('.legend .legend-item.active');
          active.forEach(a=>a.classList.remove('active'));
          renderData(originalData);
        });

        // adiciona cliques da legenda: clicar em uma faixa alterna esse filtro de intensidade
        const legendItems = document.querySelectorAll('.legend .legend-item');
        if (legendItems && legendItems.length) {
          legendItems.forEach(li => {
            li.addEventListener('click', ()=>{
              const idx = Number(li.getAttribute('data-index'));
              const already = li.classList.contains('active');
              // limpa todos os itens ativos
              document.querySelectorAll('.legend .legend-item').forEach(x=>x.classList.remove('active'));
              if (!already) {
                li.classList.add('active');
                applyFilters(idx);
              } else {
                // desativado -> mostra a seleção atual
                applyFilters(null);
              }
            });
          });
        }
        // Painel recolhível: alterna e lembra o estado
        (function(){
          const filterPanel = document.getElementById('filterPanel');
          const toggle = document.getElementById('toggleCollapse');
          if (!filterPanel || !toggle) return;
          function setCollapsed(collapsed){
            if (collapsed) filterPanel.classList.add('collapsed'); else filterPanel.classList.remove('collapsed');
            localStorage.setItem('filterCollapsed', collapsed ? '1' : '0');
            toggle.textContent = collapsed ? '▶' : '◀';
            toggle.setAttribute('aria-label', collapsed ? 'Expandir painel' : 'Recolher painel');
          }
          // inicializa a partir do armazenamento
          const stored = localStorage.getItem('filterCollapsed');
          setCollapsed(stored === '1');
          toggle.addEventListener('click', ()=> setCollapsed(!filterPanel.classList.contains('collapsed')));
        })();
      })
      .catch(err => {
        console.error('Erro ao carregar vento.json:', err);
        const loading = document.getElementById('loading');
        if (loading) {
          loading.innerText = 'Erro ao carregar dados';
          loading.style.color = '#b33';
        }
      });

    // ===== Legenda (unificada com categorias) =====
    const legenda = L.control({ position: 'bottomright' });
    legenda.onAdd = function(){
      const div = L.DomUtil.create('div','legend');
      div.innerHTML = '<div style="font-weight:600; font-size:12px; margin-bottom:6px;">Intensidade (m/s)</div>';
      const wrapper = document.createElement('div');
      wrapper.style.display='grid';
      wrapper.style.gridTemplateColumns='repeat(2, minmax(0,1fr))';
      wrapper.style.gap='6px';
      WIND_CATEGORIES.forEach((cat,i)=>{
        const item = document.createElement('button');
        item.type='button';
        item.className='legend-item';
        item.setAttribute('data-index',String(i));
        item.style.border='0';
        item.style.cursor='pointer';
        item.style.display='flex';
        item.style.alignItems='center';
        item.style.justifyContent='flex-start';
        item.style.gap='8px';
        item.style.padding='6px 8px';
        item.style.font='600 11px Inter, sans-serif';
        item.style.background='linear-gradient(145deg,#fff,#f7faf9)';
        item.style.borderRadius='8px';
        item.style.boxShadow='0 1px 2px rgba(0,0,0,0.06)';
        let faixa;
        if (cat.min === -Infinity) faixa = `< 1`;
        else if (cat.max === Infinity) faixa = `≥ ${cat.min}`;
        else faixa = `${cat.min}–${cat.max}`;
        item.innerHTML = `<span style="width:14px;height:14px;display:inline-block;border-radius:50%;background:${cat.color};box-shadow:0 0 0 2px rgba(0,0,0,0.04);"></span><span>${cat.name}</span><span style="margin-left:auto; font-weight:400; color:#555;">${faixa}</span>`;
        wrapper.appendChild(item);
      });
      div.appendChild(wrapper);
      return div;
    };
    legenda.addTo(map);

    (function(){
      const style = document.createElement('style');
      style.textContent = `.legend .legend-item.active{box-shadow:0 0 0 2px rgba(31,143,62,0.35) !important; background:linear-gradient(145deg,#eafff3,#f6fff9)!important}`;
      document.head.appendChild(style);
    })();
  </script>
</body>
</html>
